import React, { useState, useMemo, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Calendar, CalendarDays } from 'lucide-react';

// Tailwind is assumed to be available

// --- Utility Functions ---

/**
 * Gets the number of days in a given month.
 * @param {Date} date
 * @returns {number}
 */
const getDaysInMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
};

/**
 * Gets the first day of the month (0=Sunday, 6=Saturday).
 * @param {Date} date
 * @returns {number}
 */
const getFirstDayOfMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
};

/**
 * Checks if a given date is today.
 * @param {Date} date
 * @param {Date} reference
 * @returns {boolean}
 */
const isSameDay = (date1, date2) => {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
};

/**
 * Checks if a given date is in the month of the reference date.
 * @param {Date} date
 * @param {Date} reference
 * @returns {boolean}
 */
const isSameMonth = (date, reference) => {
    return date.getFullYear() === reference.getFullYear() &&
           date.getMonth() === reference.getMonth();
};


// --- Components ---

/**
 * Displays a single day's box in the month view.
 */
const DayBox = ({ dayDate, currentDate, today, onClick }) => {
    const isToday = isSameDay(dayDate, today);
    const isCurrentMonth = isSameMonth(dayDate, currentDate);

    const baseClasses = "flex flex-col items-center justify-start p-1 h-16 sm:h-20 lg:h-24 transition-colors duration-200 border-r border-b";
    
    // Non-current month days are faded
    const opacityClass = isCurrentMonth ? 'opacity-100' : 'opacity-40';
    
    // Highlight today
    const backgroundClass = isToday ? 'bg-indigo-100/70 border-indigo-500' : 'hover:bg-gray-50';

    return (
        <div
            className={`${baseClasses} ${backgroundClass} ${opacityClass} cursor-pointer`}
            onClick={() => onClick(dayDate)}
        >
            <div className={`text-xs sm:text-sm font-semibold p-1 rounded-full ${isToday ? 'bg-indigo-600 text-white' : 'text-gray-800'}`}>
                {dayDate.getDate()}
            </div>
            {/* Placeholder for events */}
            <div className="mt-1 space-y-1 w-full px-1 overflow-hidden">
                {/* Could map event previews here */}
            </div>
        </div>
    );
};

/**
 * Month view component.
 */
const MonthView = ({ currentDate, setCurrentDate, setViewMode, today }) => {
    const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    const firstDayOfMonth = getFirstDayOfMonth(currentDate);
    const daysInMonth = getDaysInMonth(currentDate);

    // Calculate days for the grid
    const days = useMemo(() => {
        const totalCells = 42; // Max 6 weeks * 7 days
        const startOffset = firstDayOfMonth;
        const previousMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
        const daysInPreviousMonth = getDaysInMonth(previousMonthDate);
        const daysArray = [];

        // Fill in days from the previous month
        for (let i = startOffset - 1; i >= 0; i--) {
            daysArray.push(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, daysInPreviousMonth - i));
        }

        // Fill in days of the current month
        for (let i = 1; i <= daysInMonth; i++) {
            daysArray.push(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));
        }

        // Fill in days from the next month
        const remainingCells = totalCells - daysArray.length;
        for (let i = 1; i <= remainingCells; i++) {
            daysArray.push(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, i));
        }

        return daysArray;
    }, [currentDate, firstDayOfMonth, daysInMonth]);

    const handleDayClick = (date) => {
        setCurrentDate(date);
        setViewMode('day');
    };

    return (
        <div className="w-full bg-white shadow-xl rounded-lg overflow-hidden">
            {/* Weekday Headers */}
            <div className="grid grid-cols-7 border-t border-l bg-gray-50/80">
                {DAYS_OF_WEEK.map(day => (
                    <div key={day} className="text-center font-bold text-sm py-2 text-indigo-700 border-r border-b">
                        {day}
                    </div>
                ))}
            </div>
            
            {/* Days Grid */}
            <div className="grid grid-cols-7 border-l">
                {days.map((dayDate, index) => (
                    <DayBox
                        key={index}
                        dayDate={dayDate}
                        currentDate={currentDate}
                        today={today}
                        onClick={handleDayClick}
                    />
                ))}
            </div>
        </div>
    );
};

/**
 * Single day view component.
 */
const DayView = ({ currentDate, today }) => {
    const formattedDate = currentDate.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    const isCurrentDay = isSameDay(currentDate, today);

    // Mock events for demonstration
    const mockEvents = [
        { time: '09:00', title: 'Team Standup', color: 'bg-green-500' },
        { time: '11:00', title: 'Project Review with Client', color: 'bg-blue-500' },
        { time: '14:30', title: '1-on-1 with Mentor', color: 'bg-yellow-500' },
        { time: '16:00', title: 'Deep Work Session', color: 'bg-indigo-500' },
    ];

    const events = isCurrentDay ? mockEvents : [];

    return (
        <div className="p-6 bg-white shadow-xl rounded-lg space-y-6">
            <h2 className="text-2xl font-extrabold text-gray-900 border-b pb-3">
                <span className="text-indigo-600">{currentDate.toLocaleDateString('en-US', { weekday: 'long' })}</span>, {formattedDate.split(', ')[1]}
            </h2>

            <div className="space-y-4">
                {events.length > 0 ? events.map((event, index) => (
                    <div key={index} className="flex items-start space-x-4 p-4 border border-gray-200 rounded-lg transition-shadow hover:shadow-md">
                        <div className={`flex-shrink-0 w-2 h-16 rounded-full ${event.color}`}></div>
                        <div>
                            <p className="text-sm font-semibold text-gray-500">{event.time}</p>
                            <h3 className="text-lg font-bold text-gray-800 mt-1">{event.title}</h3>
                        </div>
                    </div>
                )) : (
                    <div className="text-center py-12 text-gray-500">
                        <p className="text-xl font-semibold">No events scheduled.</p>
                        <p className="mt-2 text-sm">Enjoy your flexible day!</p>
                    </div>
                )}
            </div>
        </div>
    );
};


/**
 * Main Calendar Application Component.
 */
const App = () => {
    const [today] = useState(new Date());
    const [currentDate, setCurrentDate] = useState(today);
    const [viewMode, setViewMode] = useState('month'); // 'month' or 'day'

    // Formatted date string for display in the header
    const formattedHeader = useMemo(() => {
        if (viewMode === 'month') {
            return currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        } else { // day view
            return currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }
    }, [currentDate, viewMode]);

    // Function to navigate month/day
    const navigate = (direction) => {
        const newDate = new Date(currentDate);
        if (viewMode === 'month') {
            newDate.setMonth(currentDate.getMonth() + direction);
        } else { // day view
            newDate.setDate(currentDate.getDate() + direction);
        }
        setCurrentDate(newDate);
    };
    
    // Function to handle view mode change and reset to today
    const handleViewModeChange = (newMode) => {
        if (viewMode !== newMode) {
            // Reset to today's date when switching views
            setCurrentDate(today);
            setViewMode(newMode);
        }
    }

    // Button style class
    const buttonClass = (active) => 
        `px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 ${
            active ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/50' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
        }`;
    
    const navButtonClass = "p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition-colors duration-200";

    return (
        <div className="min-h-screen bg-gray-50 font-sans p-4 sm:p-8 lg:p-12">
            <div className="max-w-7xl mx-auto">
                
                {/* Fixed Header/Navigation Section */}
                <div className="sticky top-0 z-10 bg-gray-50/95 backdrop-blur-sm pt-4 pb-4 border-b border-gray-200 mb-6">
                    <header className="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                        <h1 className="text-3xl font-extrabold text-indigo-800">
                            Calendar Dashboard
                        </h1>

                        {/* View Mode Switcher */}
                        <div className="flex space-x-2 p-1 bg-white rounded-full shadow-lg">
                            <button 
                                onClick={() => handleViewModeChange('day')} 
                                className={buttonClass(viewMode === 'day')}
                            >
                                <Calendar className="w-4 h-4 mr-1 inline-block" /> Day
                            </button>
                            <button 
                                onClick={() => handleViewModeChange('month')} 
                                className={buttonClass(viewMode === 'month')}
                            >
                                <CalendarDays className="w-4 h-4 mr-1 inline-block" /> Month
                            </button>
                        </div>
                    </header>
                    
                    {/* Date Navigation and Today Button */}
                    <div className="flex justify-between items-center mt-6 p-4 bg-white rounded-xl shadow-md">
                        {/* Navigation Arrows */}
                        <div className="flex space-x-1">
                            <button 
                                onClick={() => navigate(-1)} 
                                className={navButtonClass}
                                aria-label="Previous"
                            >
                                <ChevronLeft className="w-6 h-6" />
                            </button>
                            <button 
                                onClick={() => navigate(1)} 
                                className={navButtonClass}
                                aria-label="Next"
                            >
                                <ChevronRight className="w-6 h-6" />
                            </button>
                        </div>

                        {/* Current Display Date */}
                        <h2 className="text-xl sm:text-2xl font-bold text-gray-800 px-4 text-center">
                            {formattedHeader}
                        </h2>

                        {/* Today Button */}
                        <button
                            onClick={() => setCurrentDate(today)}
                            className="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition duration-150 shadow-md"
                        >
                            Today
                        </button>
                    </div>
                </div>

                {/* Main Content Area */}
                <div className="mt-8">
                    {viewMode === 'month' ? (
                        <MonthView 
                            currentDate={currentDate} 
                            setCurrentDate={setCurrentDate} 
                            setViewMode={handleViewModeChange} 
                            today={today}
                        />
                    ) : (
                        <DayView currentDate={currentDate} today={today} />
                    )}
                </div>

                {/* Optional Footer/Information */}
                <footer className="mt-12 text-center text-gray-400 text-sm">
                    <p>Reactive Calendar Interface v1.1</p>
                </footer>
            </div>
        </div>
    );
};

export default App;
