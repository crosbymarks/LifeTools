<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intermittent Fasting Navigator</title>
    <!-- Copyright 2025 Crosby Marks -->
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for grid */
        .calendar-grid {
            /* Ensures 7 columns take up equal, full width of the container */
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        /* CRITICAL for mobile: Ensure cells maintain aspect ratio */
        .aspect-square {
            aspect-ratio: 1 / 1;
        }
        /* Style for the day cells */
        .day-cell {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .day-cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for the navigation buttons */
        .nav-btn {
            @apply p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition duration-150 ease-in-out flex items-center justify-center;
        }
        /* Custom text size for tiny details on mobile */
        .text-3xs {
            font-size: 0.5rem;
        }
        
        /* --- PRINT STYLES --- */
        .print-only-header, .print-view-details-container {
            display: none; /* Hide print-specific content in the live view */
        }
        
        @media print {
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Ensure the sticky header container acts as a normal block flow */
            .sticky.top-0.z-10 {
                position: static !important; /* CRITICAL: Resets sticky positioning for print flow */
                padding: 1rem !important; 
                border-bottom: none !important;
                background-color: white !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                /* Ensure it takes up minimal vertical space if only print-only-header is visible */
                height: auto !important; 
            }

            /* Hide all non-essential UI elements for print */
            .print-hidden, header .flex:not(:has(#current-month-display)), #message-box, footer, #schedule-description, .bg-gray-50.rounded-lg.border, .nav-btn, #view-toggle-container, .live-header-nav, .live-view-details, .day-num-live {
                display: none !important;
            }
            
            /* Show the main print header structure */
            .print-only-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px; /* Space before calendar */
                line-height: 1.1;
                padding-top: 0 !important; /* Use padding from parent container */
            }
            .print-header-month {
                font-size: 30pt; /* Bigger month */
                font-weight: 800;
                color: #000;
            }
            .print-header-year {
                font-size: 18pt;
                font-weight: 500;
                color: #333;
                margin-bottom: 5px;
            }
            #print-end-time-note {
                display: block !important;
                font-size: 14pt;
                text-align: center;
                margin-top: 10px;
                margin-bottom: 20px;
                font-weight: 600;
                color: #333;
            }

            /* Ensure the main content container expands */
            .max-w-4xl {
                max-width: 100% !important;
                box-shadow: none !important;
                padding: 1rem !important;
                margin: 0 auto !important;
            }
            
            /* Calendar Grid adjustments for print - Adding Gap/Separation */
            .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important; /* Equal columns */
                gap: 0.5rem !important; /* Add separation between cells */
                page-break-inside: avoid;
                border: none !important; /* Remove outer border if present */
            }

            /* Day Cell Content Redesign - Taller, White BG, Colored Border */
            .day-cell {
                box-shadow: none !important;
                transform: none !important;
                
                /* Keep the border width and style from the live view */
                border-width: 2px !important; 
                border-style: solid !important;
                
                /* Remove background colors and enforce white */
                background-color: white !important;
                
                padding: 0.2rem !important; 
                height: auto; 
                min-height: 120px !important; /* Taller cells */
                
                /* Centering logic */
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important; /* Vertical Center */
                align-items: center !important;     /* Horizontal Center */
            }
            
            /* Enforce White Background on all colored elements for print */
            .bg-red-100, .bg-green-100, .bg-yellow-100, .bg-orange-100, .bg-blue-100 {
                background-color: white !important;
            }

            /* Show the new detailed print container */
            .print-view-details-container {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important; /* Center content horizontally */
                justify-content: center !important;
                text-align: center !important;
                width: 100%;
                line-height: 1.3;
                
                /* Crucial: Inherit the dynamic text color set in JS */
                color: inherit !important;
            }
            
            /* Specific formatting for printed elements - Standard Day */
            /* These elements now inherit the color class set on the parent .print-view-details-container */
            .print-day-num {
                font-size: 14pt !important;
                font-weight: 900 !important;
                color: inherit !important; /* Use the dynamic color */
                margin-bottom: 3px;
            }
            
            /* Increased size to 10pt for readability */
            .print-fast-duration {
                font-weight: 700 !important; /* Bold */
                font-size: 10pt !important;
                color: inherit !important; /* Use the dynamic color */
            }
            
            /* Increased size to 10pt for readability */
            .print-eat-duration {
                font-weight: 500 !important;
                font-size: 10pt !important;
                color: #555 !important; /* Lighter shade for eat time */
            }
            
            /* Increased size to 10pt for readability */
            .print-times {
                font-size: 10pt !important;
                color: #777 !important;
                line-height: 1.2;
            }
            
            /* ---------------------------------------------------- */
            /* Formatting for Complete Fast Day (38h) */
            /* ---------------------------------------------------- */
            .print-fast-day-centered {
                align-items: center !important;
                justify-content: center !important; 
                text-align: center !important;
                padding: 5px 5px; 
            }
            
            /* Ensure Date Number inherits color, removing the old red override */
            .print-fast-day-centered .print-day-num {
                color: inherit !important; 
            }
            
            /* Increased size to 10pt for readability */
            .print-fast-word {
                font-size: 10pt !important; 
                font-weight: 900 !important; /* Bold */
                margin-top: 5px;
                color: inherit !important; 
            }
            
            /* Increased size to 10pt for readability */
            .print-duration-38h {
                font-size: 10pt !important;
                font-weight: 700 !important;
                color: inherit !important; /* Use the dynamic color (red-800) */
                margin-bottom: 2px;
            }
            
            /* Hide the tag */
            .print-fast-day-tag {
                display: none !important;
            }


            /* Force show calendar grid */
            #calendar-container {
                display: block !important;
            }
            #single-day-container {
                display: none !important;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl">

        <!-- Fixed Header and Navigation Container (STICKY TOP) -->
        <!-- This container holds the live nav and the print header -->
        <div class="sticky top-0 z-10 bg-white/95 backdrop-blur-sm p-4 sm:p-8 rounded-t-xl border-b border-gray-100">
            
            <!-- 1. LIVE VIEW MAIN TITLE - Stays at the absolute top -->
            <header class="text-center mb-4">
                <h1 class="text-2xl sm:text-4xl font-extrabold text-gray-900 print-hidden">
                    Intermittent Fasting Plan
                </h1>
            </header>

            <!-- 2. Print-Only Header Structure (Hidden in live view) -->
            <div id="print-header-structure" class="print-only-header hidden">
                <div id="print-header-month" class="print-header-month"></div>
                <div id="print-header-year" class="print-header-year"></div>
                <!-- EFT note is placed here and styled via print CSS -->
                <div id="print-end-time-note"></div>
            </div>

            <!-- 3. Live-View Navigation (Month/Year Display) -->
            <div class="live-header-nav flex items-center justify-between mt-3 space-x-4">
                <button id="prev-btn" class="nav-btn print-hidden">
                    <!-- Left Arrow SVG Icon -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                
                <h2 id="current-month-display" class="text-xl font-light text-indigo-600 w-full sm:w-auto px-4 truncate text-center">
                    <!-- Text updated via JS -->
                    Loading...
                </h2>
                
                <button id="next-btn" class="nav-btn print-hidden">
                    <!-- Right Arrow SVG Icon -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            
        </div>
        
        <!-- Main Content Area (Scrollable) -->
        <div class="p-4 sm:p-8">
            

            <!-- MONTH VIEW CONTAINER -->
            <div id="calendar-container">
                <!-- Days of the Week Header -->
                <div class="grid calendar-grid text-center font-bold text-xs sm:text-sm text-gray-500 mb-1 border-b-2 border-gray-100 pb-1">
                    <span class="p-1">Sun</span>
                    <span class="p-1">Mon</span>
                    <span class="p-1">Tue</span>
                    <span class="p-1">Wed</span>
                    <span class="p-1">Thu</span>
                    <span class="p-1">Fri</span>
                    <span class="p-1">Sat</span>
                </div>

                <!-- Calendar Grid Container -->
                <div id="calendar-grid" class="calendar-grid grid gap-1 sm:gap-2 mb-8">
                    <!-- Calendar days will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- SINGLE DAY VIEW CONTAINER (Hidden by default) -->
            <div id="single-day-container" class="hidden mb-8">
                <div id="day-card" class="bg-white border-2 rounded-xl p-6 shadow-md transition-all duration-300">
                    <!-- Content injected via JS -->
                </div>
            </div>
            
            <!-- VIEW TOGGLE CONTAINER (MOVED HERE) -->
            <div id="view-toggle-container" class="flex justify-center items-center space-x-3 mt-4 mb-6 print-hidden">
                <!-- Today Button -->
                <button id="view-today-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition shadow-sm">
                    Today
                </button>
                
                <div class="bg-gray-100 p-1 rounded-lg flex items-center">
                    <button id="view-month-btn" class="px-6 py-2 text-sm font-semibold rounded-md transition bg-white shadow-sm text-indigo-600">Month View</button>
                    <button id="view-day-btn" class="px-6 py-2 text-sm font-semibold rounded-md transition text-gray-500 hover:text-gray-700">Single Day View</button>
                </div>
            </div>

            <!-- Schedule Chooser and Time Selector -->
            <div class="flex flex-col md:flex-row justify-center items-center space-y-3 md:space-y-0 md:space-x-6 mt-4 print-hidden">
                <!-- Schedule Chooser -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="mode-fixed-btn" class="px-4 py-2 text-sm font-semibold rounded-lg transition" data-mode="0">
                        4-5-4-1 Repeating Cycle
                    </button>
                    <button id="mode-two-cycle-btn" class="px-4 py-2 text-sm font-semibold rounded-lg transition" data-mode="2">
                        Two-Cycle Thursday Anchor
                    </button>
                </div>

                <!-- Time Selector -->
                <div class="flex items-center space-x-2 p-2 bg-gray-100 rounded-lg">
                    <label for="end-fast-time" class="text-sm font-semibold text-gray-700">End Fast Time (EFT):</label>
                    <input type="time" id="end-fast-time" value="20:00" class="p-1 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-28 text-center text-sm font-mono cursor-pointer">
                </div>
                
                <!-- Print Button -->
                <button id="print-calendar-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
                    üñ®Ô∏è
                </button>
                
                <!-- Export Button -->
                <button id="export-ics-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition">
                    üìÖ
                </button>
            </div>
            
            
            <!-- Message Box for Click Events / Error Display -->
            <div id="message-box" class="mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-center text-sm text-gray-700 hidden transition-opacity duration-300 print-hidden">
                <!-- Content filled by JavaScript on day click or error -->
            </div>

            <!-- Legend -->
            <div class="mt-6 p-3 bg-gray-50 rounded-lg border border-gray-200 print-hidden">
                <h3 class="text-base font-semibold text-gray-700 mb-3 text-center">Schedule Key</h3>
                <div class="flex flex-wrap gap-x-4 gap-y-2 justify-center">
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        <span class="text-xs text-gray-600">12h/12h</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        <span class="text-xs text-gray-600">14h/10h</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        <span class="text-xs text-gray-600">16h/8h</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                        <span class="text-xs text-gray-600">18h/6h</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="text-xs text-gray-600">Fast (36h/38h)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-indigo-500 text-sm">‚òÖ</span>
                        <span class="text-xs text-gray-600">Today</span>
                    </div>
                </div>
            </div>
            
            <!-- Explanation -->
            <p id="schedule-description" class="mt-6 text-gray-600 text-sm max-w-xl mx-auto text-center print-hidden">
                <!-- Content set dynamically -->
            </p>

            <!-- Copyright Footer -->
            <footer class="mt-8 pt-4 border-t border-gray-100 text-center print-hidden">
                <p class="text-xs text-gray-400">
                    &copy; 2025 Crosby Marks. All rights reserved.
                </p>
            </footer>
        </div>

    </div>

    <!-- The script is now a standard module to use local storage -->
    <script type="module">
        // --- GLOBAL STATE & CONSTANTS ---
        const calendarGrid = document.getElementById('calendar-grid');
        const monthDisplay = document.getElementById('current-month-display');
        const descriptionElement = document.getElementById('schedule-description');
        const fixedBtn = document.getElementById('mode-fixed-btn');
        const twoCycleBtn = document.getElementById('mode-two-cycle-btn');
        const endTimeInput = document.getElementById('end-fast-time');
        const messageBox = document.getElementById('message-box');
        const printBtn = document.getElementById('print-calendar-btn');
        const exportBtn = document.getElementById('export-ics-btn'); 
        
        // Print Header Elements
        const printHeaderMonth = document.getElementById('print-header-month');
        const printHeaderYear = document.getElementById('print-header-year');
        const printEndTimeNote = document.getElementById('print-end-time-note'); 

        // Containers
        const calendarContainer = document.getElementById('calendar-container');
        const singleDayContainer = document.getElementById('single-day-container');
        
        // View Toggle Buttons
        const viewMonthBtn = document.getElementById('view-month-btn');
        const viewDayBtn = document.getElementById('view-day-btn');
        const viewTodayBtn = document.getElementById('view-today-btn'); 
        
        // Nav Buttons
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        // Define today's date for highlighting
        const TODAY = new Date();
        const TODAY_YEAR = TODAY.getFullYear();
        const TODAY_MONTH = TODAY.getMonth();
        const TODAY_DAY = TODAY.getDate();

        // Calendar now starts on today's month and year
        let currentMonth = TODAY_MONTH; 
        let currentYear = TODAY_YEAR;
        
        // New State for Single Day View
        let viewMode = 'month'; // 'month' or 'day'
        let selectedDate = new Date(TODAY); // Defaults to today
        
        // 0: Fixed 14-day cycle, 2: Two-Cycle Thursday Anchor
        let scheduleMode = 2; 
        let endFastTime = '20:00'; 

        // Cache the schedule for the current month
        let currentMonthSchedule = []; 
        
        // Define Tailwind classes and schedule data 
        const STYLES = {
            '12/12': { fast: 12, eat: 12, bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300', name: '12h/12h' }, 
            '14/10': { fast: 14, eat: 10, bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300', name: '14h/10h' },
            '16/8':  { fast: 16, eat: 8, bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300', name: '16h/8h' },
            '18/6':  { fast: 18, eat: 6, bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-300', name: '18h/6h' },
            '38h':   { fast: 38, eat: 0, bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300', name: '38h Fast' } 
        };

        const s12 = STYLES['12/12']; 
        const s14 = STYLES['14/10'];
        const s16 = STYLES['16/8'];
        const s18 = STYLES['18/6'];
        const s38 = STYLES['38h'];

        // --- UTILITY FUNCTIONS ---
        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function findNthDay(n, dayOfWeek, month, year) {
            let count = 0;
            let day = 1;
            while (day <= getDaysInMonth(month, year)) {
                const date = new Date(year, month, day);
                if (date.getDay() === dayOfWeek) {
                    count++;
                    if (count === n) { return day; }
                }
                day++;
            }
            return null;
        }
        
        const timeFormatter = new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        const dayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        function formatIcsDate(date) {
            const pad = (num) => String(num).padStart(2, '0');
            return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`;
        }
        
        function showMessageBox(message, type = 'info') {
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden', 'bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200');
            messageBox.classList.add(
                type === 'error' ? 'bg-red-50' : (type === 'success' ? 'bg-green-50' : 'bg-indigo-50'),
                type === 'error' ? 'border-red-200' : (type === 'success' ? 'border-green-200' : 'border-indigo-200')
            );
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        function saveSettings() {
            try { 
                localStorage.setItem('fastingScheduleMode', scheduleMode.toString());
                localStorage.setItem('endFastTime', endFastTime);
                localStorage.setItem('viewMode', viewMode);
            } catch (e) { console.error("Error saving settings:", e); }
        }
        
        function loadSettings() {
            try {
                const storedMode = localStorage.getItem('fastingScheduleMode');
                if (storedMode !== null) {
                    const loadedMode = parseInt(storedMode, 10);
                    if (!isNaN(loadedMode) && (loadedMode === 0 || loadedMode === 2)) { scheduleMode = loadedMode; }
                }
                const storedTime = localStorage.getItem('endFastTime');
                if (storedTime !== null) {
                    endFastTime = storedTime;
                    if (endTimeInput) endTimeInput.value = storedTime;
                }
                const storedView = localStorage.getItem('viewMode');
                if (storedView === 'month' || storedView === 'day') {
                    viewMode = storedView;
                }
            } catch (e) { console.error("Error loading settings:", e); }
        }


        // --- SCHEDULE GENERATION ---
        function generateFixedCycleSchedule(daysInMonth) {
            const strictSchedule = new Array(daysInMonth).fill(null);
            const cycle = [...Array(4).fill(s14), ...Array(5).fill(s16), ...Array(4).fill(s18), s38];
            let ptr = 0;
            // Fill full cycles
            while (ptr + 14 <= daysInMonth) {
                for(let i=0; i<14; i++) strictSchedule[ptr+i] = cycle[i];
                ptr += 14;
            }
            // Fill remainder with s12
            for(let i=ptr; i<daysInMonth; i++) strictSchedule[i] = s12;
            
            return strictSchedule;
        }

        function generateTwoCycleAnchorSchedule(month, year) {
            const daysInMonth = getDaysInMonth(month, year);
            const scheduleData = new Array(daysInMonth).fill(null);
            const THURSDAY = 4;
            const firstThursday = findNthDay(1, THURSDAY, month, year); 
            
            if (firstThursday === null) { return new Array(daysInMonth).fill(s12); }

            const applyFast = (day, fastType) => { if (day >= 1 && day <= daysInMonth) { scheduleData[day - 1] = fastType; } };
            
            for(let day = 1; day < firstThursday; day++) { applyFast(day, s12); }

            const cyclePattern = [{ style: s14, count: 4 }, { style: s16, count: 5 }, { style: s18, count: 4 }, { style: s38, count: 1 }];

            const applyCycle = (startDay) => {
                let currentDay = startDay;
                for (const segment of cyclePattern) {
                    for (let i = 0; i < segment.count; i++) {
                        if (currentDay <= daysInMonth) {
                            if (!scheduleData[currentDay - 1]) { applyFast(currentDay, segment.style); }
                            currentDay++;
                        } else { return null; }
                    }
                }
                return currentDay;
            };

            let nextDay = applyCycle(firstThursday);
            if (nextDay && nextDay <= daysInMonth) { nextDay = applyCycle(nextDay); }

            if (nextDay && nextDay <= daysInMonth) {
                for (let day = nextDay; day <= daysInMonth; day++) { applyFast(day, s12); }
            }

            for(let day = 1; day <= daysInMonth; day++) {
                if (!scheduleData[day - 1]) { scheduleData[day - 1] = s12; }
            }
            return scheduleData;
        }
        
        function generateSchedule(month, year) {
            if (scheduleMode === 0) { return generateFixedCycleSchedule(getDaysInMonth(month, year)); } 
            else { return generateTwoCycleAnchorSchedule(month, year); }
        }
        
        // --- DYNAMIC CALCULATION HELPERS ---
        function getNextDaySchedule(day, month, year) {
            const clickedDayIndex = day - 1;
            
            let monthSchedule = currentMonthSchedule;
            if (!monthSchedule || monthSchedule.length === 0 || month !== currentMonth || year !== currentYear) {
                monthSchedule = generateSchedule(month, year);
            }

            if (clickedDayIndex + 1 < monthSchedule.length) {
                return monthSchedule[clickedDayIndex + 1];
            } 
            
            // If the next day is in the next month, we need to calculate its schedule.
            const nextDate = new Date(year, month, day + 1);
            if (scheduleMode === 0) {
                // For Fixed Cycle, the next day is always the start of the cycle (s14) unless we are mid-cycle which is handled by the first check.
                // If we hit the end of the month, the logic assumes a repeat or s12 if out of bounds. Let's use s14 as a fallback for the next month's start.
                 return s14; 
            } else { 
                // Two-Cycle Anchor: Check if the next day is the first Thursday.
                const THURSDAY = 4;
                const firstThursdayOfNextMonth = findNthDay(1, THURSDAY, nextDate.getMonth(), nextDate.getFullYear());
                if (nextDate.getDate() === firstThursdayOfNextMonth) { return s14; } 
                else { return s12; } // Otherwise, default to s12 (buffer).
            }
        }

        function getEventDetailsForDay(day, month, year, scheduleData) {
            const dayData = scheduleData[day - 1];
            if (!dayData) {
                 // This should only happen for padding days or bad index, but return s12 as safe default
                return getEventDetailsForDay(day, month, year, new Array(getDaysInMonth(month, year)).fill(s12));
            }
            
            const fastDuration = dayData.fast;
            const eatingWindow = dayData.eat;
            const [hours, minutes] = endFastTime.split(':').map(Number);
            
            const endTimeD = new Date(year, month, day, hours, minutes);
            const details = { type: 'standard', fastStart: null, fastEnd: null, eatStart: null, eatEnd: null, calculatedFastHours: null, schedule: dayData };

            if (fastDuration === 38) {
                // 38h/36h Fast (Fast starts the previous day and ends tomorrow)
                
                // Get the schedule for the next day to determine the eating window size.
                const nextDaySchedule = getNextDaySchedule(day, month, year);
                const eatingWindowDPlus1 = nextDaySchedule.eat; 
                
                // Fast Start: End Fast Time of previous day (day - 1)
                details.fastStart = new Date(year, month, day, hours, minutes);
                details.fastStart.setDate(details.fastStart.getDate() - 1); 

                // Fast End: End Fast Time of tomorrow (day + 1) minus the next day's eating window.
                details.fastEnd = new Date(year, month, day + 1, hours, minutes); 
                details.fastEnd.setHours(details.fastEnd.getHours() - eatingWindowDPlus1); 

                const diffMs = details.fastEnd.getTime() - details.fastStart.getTime();
                details.calculatedFastHours = Math.round(diffMs / (1000 * 60 * 60)); 
                details.type = 'fast';
                
            } else {
                // Standard Fast
                details.eatEnd = endTimeD;
                details.eatStart = new Date(details.eatEnd);
                details.eatStart.setHours(details.eatEnd.getHours() - eatingWindow);
                details.fastEnd = details.eatStart;
                details.fastStart = new Date(details.fastEnd);
                details.fastStart.setHours(details.fastEnd.getHours() - fastDuration);
                details.type = 'standard';
            }
            return details;
        }


        // --- RENDER FUNCTIONS ---
        
        function updateViewToggleUI() {
            // Update button styles
            viewMonthBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600', 'text-gray-500', 'hover:text-gray-700');
            viewDayBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600', 'text-gray-500', 'hover:text-gray-700');

            // Get EFT for print header update
            const [hours, minutes] = endFastTime.split(':').map(Number);
            const dummyDate = new Date(2000, 0, 1, hours, minutes);
            const formattedEFT = timeFormatter.format(dummyDate);

            // Update Print Header (Always update, visibility is handled by print CSS)
            printHeaderMonth.textContent = monthNames[currentMonth];
            printHeaderYear.textContent = currentYear;
            printEndTimeNote.textContent = `Eating Ends At (EFT): ${formattedEFT}`;

            if (viewMode === 'month') {
                viewMonthBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                viewDayBtn.classList.add('text-gray-500', 'hover:text-gray-700');
                
                calendarContainer.classList.remove('hidden');
                singleDayContainer.classList.add('hidden');
                
                // Header update for month (Live View)
                monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
            } else {
                viewDayBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                viewMonthBtn.classList.add('text-gray-500', 'hover:text-gray-700');
                
                calendarContainer.classList.add('hidden');
                singleDayContainer.classList.remove('hidden');
                
                // Header update for day (Live View)
                monthDisplay.textContent = dayFormatter.format(selectedDate);
                renderSingleDayView();
            }
        }

        function renderSingleDayView() {
            const dayCard = document.getElementById('day-card');
            
            // Ensure we have schedule data for the selected date
            const sMonth = selectedDate.getMonth();
            const sYear = selectedDate.getFullYear();
            const sDay = selectedDate.getDate();
            
            // Generate schedule for the current month of the selected date
            const scheduleData = generateSchedule(sMonth, sYear);
            const details = getEventDetailsForDay(sDay, sMonth, sYear, scheduleData);
            const data = details.schedule;
            
            // Determine Styling
            const isToday = (TODAY_YEAR === sYear && TODAY_MONTH === sMonth && TODAY_DAY === sDay);
            const borderColor = data.bg.replace('bg-', 'border-').replace('100', '500'); // Approximate darker border
            const bgColor = data.bg;
            const textColor = data.text;
            
            // Build the HTML for the card
            let html = `
                <div class="flex flex-col items-center">
                    <div class="w-full text-center mb-4">
                        <span class="inline-block px-4 py-1 rounded-full text-sm font-bold ${bgColor} ${textColor} mb-2">
                            ${isToday ? '‚òÖ TODAY - ' : ''}${data.name}
                        </span>
                        <h3 class="text-3xl font-extrabold text-gray-800">${data.fast === 38 ? 'Extended Fast' : data.fast + 'h Fasting Day'}</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-lg">
            `;
            
            if (details.type === 'fast') {
                // 38h Fast: One event (Fast Ends)
                // 38h/36h Fast Layout
                html += `
                        <div class="bg-red-50 p-4 rounded-lg text-center border border-red-100">
                            <p class="text-xs uppercase text-red-400 font-bold mb-1">Fast Duration</p>
                            <p class="text-2xl font-bold text-red-700">${details.calculatedFastHours} Hours</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center border border-red-100">
                            <p class="text-xs uppercase text-red-400 font-bold mb-1">Eating Window</p>
                            <p class="text-xl font-medium text-red-700">None Today</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-100 sm:col-span-2">
                            <p class="text-xs uppercase text-gray-500 font-bold mb-1">Fasting Timeline</p>
                            <div class="flex justify-between items-center px-4 mt-2">
                                <div class="text-left">
                                    <span class="block text-xs text-gray-400">Started</span>
                                    <span class="block font-bold text-gray-800">${timeFormatter.format(details.fastStart)}</span>
                                    <span class="block text-xs text-gray-500">${details.fastStart.getMonth() === sMonth ? 'Yesterday' : monthNames[details.fastStart.getMonth()]}</span>
                                </div>
                                <div class="text-gray-300">‚ûú</div>
                                <div class="text-right">
                                    <span class="block text-xs text-gray-400">Ends</span>
                                    <span class="block font-bold text-gray-800">${timeFormatter.format(details.fastEnd)}</span>
                                    <span class="block text-xs text-gray-500">${details.fastEnd.getMonth() === sMonth ? 'Tomorrow' : monthNames[details.fastEnd.getMonth()]}</span>
                                </div>
                            </div>
                        </div>
                `;
            } else {
                // Standard Day Layout
                html += `
                        <div class="bg-indigo-50 p-4 rounded-lg text-center border border-indigo-100">
                            <p class="text-xs uppercase text-indigo-400 font-bold mb-1">Eating Window</p>
                            <p class="text-2xl font-bold text-indigo-700">${data.eat} Hours</p>
                            <p class="text-sm font-medium text-indigo-600 mt-1">
                                ${timeFormatter.format(details.eatStart)} - ${timeFormatter.format(details.eatEnd)}
                            </p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-100">
                            <p class="text-xs uppercase text-gray-400 font-bold mb-1">Fasting</p>
                            <p class="text-2xl font-bold text-gray-600">${data.fast} Hours</p>
                            <p class="text-sm font-medium text-gray-500 mt-1">
                                until ${timeFormatter.format(details.eatStart)}
                            </p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-100 sm:col-span-2">
                            <p class="text-xs uppercase text-gray-500 font-bold mb-1">Schedule Breakdown</p>
                            <div class="flex justify-between text-sm mt-2 px-2">
                                <div>
                                    <span class="block font-bold text-gray-700">Fast Ends</span>
                                    <span class="block text-gray-500">${timeFormatter.format(details.eatStart)}</span>
                                </div>
                                <div>
                                    <span class="block font-bold text-indigo-600">Eat Start</span>
                                    <span class="block text-indigo-400">${timeFormatter.format(details.eatStart)}</span>
                                </div>
                                <div>
                                    <span class="block font-bold text-gray-700">Fast Starts</span>
                                    <span class="block text-gray-500">${timeFormatter.format(details.eatEnd)}</span>
                                </div>
                            </div>
                        </div>
                `;
            }
            
            html += `</div></div>`;
            
            // Apply a colored border to the card corresponding to the day type
            dayCard.className = `bg-white border-4 rounded-xl p-6 shadow-md transition-all duration-300 ${borderColor}`;
            dayCard.innerHTML = html;
        }

        function renderCalendar(month, year) {
            // Update cache for current month context
            currentMonth = month;
            currentYear = year;
            
            // Get EFT for print header update
            const [hours, minutes] = endFastTime.split(':').map(Number);
            const dummyDate = new Date(2000, 0, 1, hours, minutes);
            const formattedEFT = timeFormatter.format(dummyDate);

            // Update Print Header (Always update, visibility is handled by print CSS)
            if (printHeaderMonth && printHeaderYear && printEndTimeNote) {
                printHeaderMonth.textContent = monthNames[currentMonth];
                printHeaderYear.textContent = currentYear;
                printEndTimeNote.textContent = `Eating Ends At (EFT): ${formattedEFT}`;
            }

            // Only update month header if in month view
            if (viewMode === 'month') {
                monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            }


            // Generate Data
            const daysInMonth = getDaysInMonth(month, year);
            const scheduleData = generateSchedule(month, year);
            currentMonthSchedule = scheduleData; 
            
            // Clear Grid
            calendarGrid.innerHTML = '';
            
            const date = new Date(year, month, 1);
            const startDayOfWeek = date.getDay(); 
            const isCurrentMonth = (year === TODAY_YEAR && month === TODAY_MONTH);

            // Padding
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('p-1', 'aspect-square', 'bg-white', 'rounded-lg', 'shadow-inner', 'h-full');
                calendarGrid.appendChild(emptyCell);
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = scheduleData[day - 1]; 
                const details = getEventDetailsForDay(day, month, year, scheduleData);
                const { fast, eat, bg, text, border } = dayData;

                const cell = document.createElement('div');
                
                const classesToAdd = [
                    'day-cell', 'rounded-lg', 'p-1', 'sm:p-3', 'text-center',
                    'flex', 'flex-col', 'justify-between', 'aspect-square',
                    'border-2'
                ];
                
                // Live View Styling
                if (fast === 38) {
                    // 38h Days: Light Red Background, Red Text, Red Border
                    cell.classList.add(STYLES['38h'].bg, STYLES['38h'].text, STYLES['38h'].border);
                } else {
                    // Standard Days: Use schedule colors
                    cell.classList.add(bg, text, border);
                }

                cell.classList.add(...classesToAdd);
                
                // Add click handler to switch to day view for the clicked date
                cell.addEventListener('click', () => {
                    handleDayClick(year, month, day);
                });

                // --- 1. Live View Day Number ---
                const dayNumLive = document.createElement('div');
                dayNumLive.classList.add('day-num-live', 'text-lg', 'sm:text-xl', 'font-extrabold', 'mb-0', 'flex', 'items-center', 'justify-center');
                dayNumLive.textContent = day;
                
                if (isCurrentMonth && day === TODAY_DAY) {
                    const todayIcon = document.createElement('span');
                    todayIcon.innerHTML = '‚òÖ'; 
                    todayIcon.classList.add('text-indigo-500', 'text-xs', 'ml-1', 'align-top', 'font-normal');
                    dayNumLive.appendChild(todayIcon);
                }
                
                cell.appendChild(dayNumLive);

                // --- 2. Live View Details (Fast/Eat Hours) ---
                const liveViewDetails = document.createElement('div');
                liveViewDetails.classList.add('live-view-details', 'text-3xs', 'sm:text-xs', 'font-semibold', 'leading-tight', 'truncate');

                if (fast === 38) {
                    liveViewDetails.innerHTML = `<span class="block">Fast</span><span class="block font-normal">(36h/38h)</span>`;
                } else {
                    liveViewDetails.innerHTML = `<span class="block">${fast}h Fast</span><span class="block font-normal">${eat}h Eat</span>`;
                }
                cell.appendChild(liveViewDetails);

                // --- 3. Print View Details (New, detailed, stacked format) ---
                const printViewDetailsContainer = document.createElement('div');
                // CRITICAL FIX: Pass the schedule's text color class to the print container 
                // and the border color class to maintain color in print view.
                printViewDetailsContainer.classList.add('print-view-details-container', 'hidden', dayData.text); 

                // Determine content based on fast type
                if (fast === 38) {
                    // NEW: Centered, specific 4-line display for 38h fast days
                    
                    // Add centering style for the print container
                    printViewDetailsContainer.classList.add('print-fast-day-centered');
                    
                    // Line 1: Date (Bigger & Bold)
                    printViewDetailsContainer.innerHTML += `<span class="print-day-num">${day}</span>`;
                    
                    // Line 2: FAST DAY (Bold, 10pt)
                    printViewDetailsContainer.innerHTML += `<span class="print-fast-word">FAST DAY</span>`;
                    
                    // Line 3: Duration (10pt)
                    printViewDetailsContainer.innerHTML += `<span class="print-duration-38h">36/38h</span>`;
                    
                    // Line 4: FAST DAY tag (kept for compatibility, though hidden by CSS)
                    printViewDetailsContainer.innerHTML += `<span class="print-fast-day-tag">FAST DAY</span>`;

                } else {
                    // Standard Day Layout (5 lines: Date, Fast, Eat, Start Time, End Time)
                    
                    let fastDurationText = `${fast}h Fast`;
                    let eatDurationText = `${eat}h Eat`;
                    let startTimeText = timeFormatter.format(details.eatStart).replace(/\s/g, '&nbsp;');
                    let endTimeText = timeFormatter.format(details.eatEnd).replace(/\s/g, '&nbsp;');
                    
                    // Line 1: Date (Bigger & Bold)
                    printViewDetailsContainer.innerHTML += `<span class="print-day-num">${day}</span>`;
                    
                    // Line 2: Fast Duration (Bold, 10pt)
                    printViewDetailsContainer.innerHTML += `<span class="print-fast-duration">${fastDurationText}</span>`;
                    
                    // Line 3: Eat Duration (10pt)
                    printViewDetailsContainer.innerHTML += `<span class="print-eat-duration">${eatDurationText}</span>`;
                    
                    // Lines 4 & 5: Start/End Times (10pt)
                    printViewDetailsContainer.innerHTML += `<span class="print-times">${startTimeText}</span>`;
                    printViewDetailsContainer.innerHTML += `<span class="print-times">${endTimeText}</span>`;
                }

                cell.appendChild(printViewDetailsContainer);
                
                calendarGrid.appendChild(cell); 
            }
        }

        // --- HANDLERS ---

        function handlePrev() {
            if (viewMode === 'month') {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar(currentMonth, currentYear);
            } else {
                // Single Day Prev: Create a new Date object to avoid modifying the previous day's object
                selectedDate = new Date(selectedDate);
                selectedDate.setDate(selectedDate.getDate() - 1);
                updateViewToggleUI(); // Rerenders single day view and updates header
            }
        }

        function handleNext() {
            if (viewMode === 'month') {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar(currentMonth, currentYear);
            } else {
                // Single Day Next: Create a new Date object
                selectedDate = new Date(selectedDate);
                selectedDate.setDate(selectedDate.getDate() + 1);
                updateViewToggleUI(); // Rerenders single day view and updates header
            }
        }

        function setScheduleMode(mode) {
            if (scheduleMode === mode) return; 
            scheduleMode = mode;
            updateUI(mode);
            renderCalendar(currentMonth, currentYear);
            if(viewMode === 'day') renderSingleDayView();
            saveSettings();
        }

        function setEndFastTime(event) {
            endFastTime = event.target.value;
            saveSettings();
            renderCalendar(currentMonth, currentYear);
            if(viewMode === 'day') renderSingleDayView();
        }
        
        /**
         * FIX: Handles the click from a day cell to set the date and switch view
         */
        function handleDayClick(year, month, day) {
            selectedDate = new Date(year, month, day);
            viewMode = 'day'; // Explicitly switch to day mode
            updateViewToggleUI(); // Updates UI and renders single day view
            saveSettings();
            showMessageBox(`üìÖ Switched to Single Day View for **${monthNames[month]} ${day}, ${year}**.`);
        }
        
        /**
         * Toggles the view mode using the buttons. This function DOES NOT reset the date.
         */
        function toggleView(mode) {
            if (viewMode !== mode) {
                viewMode = mode;
                
                // If switching back to month view, ensure the current month/year is rendered
                if (mode === 'month') {
                    renderCalendar(currentMonth, currentYear);
                }
                
                updateViewToggleUI(); 
                saveSettings(); // Save the new view mode
            }
        }
        
        /**
         * Resets the current view's date back to today.
         */
        function goToToday() {
            if (viewMode === 'month') {
                currentMonth = TODAY_MONTH;
                currentYear = TODAY_YEAR;
                renderCalendar(currentMonth, currentYear);
                showMessageBox('üìÖ Calendar reset to **Today** (Month View).');
            } else { // viewMode === 'day'
                selectedDate = new Date(TODAY);
                renderSingleDayView(); // Renders the day view for the new selectedDate
                showMessageBox('üìÖ Calendar reset to **Today** (Single Day View).');
            }
            updateViewToggleUI(); // Updates the header text for both modes
            saveSettings(); // Save current view mode
        }


        function updateUI(mode) {
            [fixedBtn, twoCycleBtn].forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white', 'bg-gray-200', 'text-gray-700'));
            let activeBtn, description;
            if (mode === 0) {
                activeBtn = fixedBtn;
                description = 'The **14-day cycle** (4-5-4-1) restarts on the first of the month. The long fast is always **38h**.';
            } else { 
                activeBtn = twoCycleBtn;
                description = 'Two 14-day cycles (4-5-4-1) start on the **First Thursday** of the month. Buffer days use **12h/12h**. The long fast dynamically calculates to **36h or 38h**.';
            }
            activeBtn.classList.add('bg-indigo-600', 'text-white');
            [fixedBtn, twoCycleBtn].filter(btn => btn !== activeBtn).forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
            descriptionElement.innerHTML = description;
        }

        // --- EXPORT FUNCTION ---
        function generateIcsFile() {
            const filename = `FastingSchedule_${monthNames[currentMonth]}${currentYear}.ics`;
            const scheduleData = generateSchedule(currentMonth, currentYear);
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone; 

            let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//FastingNavigator//NONSGML v1.0//EN\n`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = scheduleData[day - 1];
                const details = getEventDetailsForDay(day, currentMonth, currentYear, scheduleData);
                const uidPrefix = `NAV-${currentYear}${String(currentMonth + 1).padStart(2, '0')}${String(day).padStart(2, '0')}-${Date.now()}`;

                if (details.type === 'fast') {
                    // 38h Fast: One event (Fast Ends)
                    const summary = `${details.calculatedFastHours}h Fast ENDS`;
                    const description = `This marks the end of your ${details.calculatedFastHours}h fast. Start your eating window now.`;
                    
                    icsContent += `BEGIN:VEVENT\n`;
                    icsContent += `UID:${uidPrefix}-FASTEND\n`;
                    icsContent += `DTSTAMP:${formatIcsDate(new Date())}\n`;
                    icsContent += `DTSTART;TZID=${timezone}:${formatIcsDate(details.fastEnd)}\n`;
                    const endMarker = new Date(details.fastEnd);
                    endMarker.setMinutes(endMarker.getMinutes() + 1);
                    icsContent += `DTEND;TZID=${timezone}:${formatIcsDate(endMarker)}\n`;
                    icsContent += `SUMMARY:${summary}\n`;
                    icsContent += `DESCRIPTION:${description}\n`;
                    icsContent += `END:VEVENT\n`;

                } else {
                    // Standard Day: One event (Eating Window)
                    const eatSummary = `EATING: ${dayData.eat}h Window (${dayData.fast}/${dayData.eat})`;
                    const eatDescription = `Your ${dayData.eat}h eating window starts at ${timeFormatter.format(details.eatStart)} and ends at ${timeFormatter.format(details.eatEnd)}.`;
                    
                    icsContent += `BEGIN:VEVENT\n`;
                    icsContent += `UID:${uidPrefix}-EATWIN\n`;
                    icsContent += `DTSTAMP:${formatIcsDate(new Date())}\n`;
                    icsContent += `DTSTART;TZID=${timezone}:${formatIcsDate(details.eatStart)}\n`;
                    icsContent += `DTEND;TZID=${timezone}:${formatIcsDate(details.eatEnd)}\n`;
                    icsContent += `SUMMARY:${eatSummary}\n`;
                    icsContent += `DESCRIPTION:${eatDescription}\n`;
                    icsContent += `END:VEVENT\n`;
                }
            }

            icsContent += `END:VCALENDAR\n`;
            
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessageBox(`‚úÖ Exported **${daysInMonth} events** for ${monthNames[currentMonth]} ${currentYear} to **${filename}**.`);
        }

        // --- INITIALIZATION ---
        function initialize() {
            loadSettings();
            
            // Listeners
            prevBtn.addEventListener('click', handlePrev);
            nextBtn.addEventListener('click', handleNext);
            fixedBtn.addEventListener('click', () => setScheduleMode(0));
            twoCycleBtn.addEventListener('click', () => setScheduleMode(2));
            endTimeInput.addEventListener('change', setEndFastTime);
            printBtn.addEventListener('click', () => window.print());
            
            if (exportBtn) {
                exportBtn.addEventListener('click', generateIcsFile);
            }

            // View Toggle Listeners (use toggleView which preserves date/time)
            viewMonthBtn.addEventListener('click', () => toggleView('month'));
            viewDayBtn.addEventListener('click', () => toggleView('day'));
            
            // Today Button Listener (uses goToToday which handles the date reset)
            viewTodayBtn.addEventListener('click', goToToday); 

            // Render
            updateUI(scheduleMode);
            try {
                // Always render calendar first to prep data
                renderCalendar(currentMonth, currentYear);
                // Then set UI based on stored view mode
                updateViewToggleUI();
            } catch (error) {
                showMessageBox(`üí• Critical Error: ${error.message}`);
                console.error(error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>
